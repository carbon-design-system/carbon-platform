name: Publish RMDX web-app
on:
  # Enable running this workflow manually from the Actions tab
  workflow_dispatch:

env:
  CI: 'true'

jobs:
  build-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ğŸ›
        uses: actions/checkout@v3

      - name: Setup Node ğŸ—
        uses: actions/setup-node@v3
        with:
          node-version: '16'
          cache: 'npm'

      - name: Install Micromanage ğŸ”¬
        run: npm --workspace packages/micromanage-cli install

      - name: Setup Docker ğŸ³
        run: docker login -u iamapikey -p ${{ secrets.CONTAINER_REGISTRY_API_KEY }} us.icr.io

      - name: Build root image ğŸ”¨
        run: npx micromanage docker build --pull @carbon-platform/root

      - name: Build and push ğŸ”¨ ğŸš€
        run: |
          npx micromanage docker build @carbon-platform/web-app
          docker tag us.icr.io/carbon-platform/web-app:latest us.icr.io/carbon-platform-test/web-app:rmdx-latest
          docker push us.icr.io/carbon-platform-test/web-app:rmdx-latest
        env:
          CARBON_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
